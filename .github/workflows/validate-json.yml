name: Validate JSON

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'books/**.json'
      - 'books/**/hadiths/**.json'
      - 'schema.json'
  pull_request:
    paths:
      - 'books/**.json'
      - 'books/**/hadiths/**.json'
      - 'schema.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install -g ajv-cli jsonlint

      - name: Validate JSON Syntax and Schema
        run: |
          set -e  # Exit immediately on error
          shopt -s globstar nullglob
          files=(books/**/*.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No JSON files found in books/."
            exit 0
          fi

          echo "üîç Validating JSON syntax..."
          for file in "${files[@]}"; do
            echo "‚Üí $file"
            jsonlint "$file" -q
          done

          echo "üìê Validating against schema.json..."
          for file in "${files[@]}"; do
            echo "‚Üí $file"
            ajv validate -s schema.json -d "$file"
          done