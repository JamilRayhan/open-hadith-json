name: Validate JSON

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'books/**.json'
      - 'books/**/hadiths/**.json'
      - '*.schema.json'
  pull_request:
    paths:
      - 'books/**.json'
      - 'books/**/hadiths/**.json'
      - '*.schema.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install -g ajv-cli jsonlint

      - name: Validate JSON Syntax and Schema
        run: |
          set -e  # Exit immediately on error
          shopt -s globstar nullglob
          
          echo "üîç Validating JSON syntax..."
          for file in books/**/*.json; do
            [ -f "$file" ] || continue
            echo "‚Üí $file"
            jsonlint "$file" -q
          done

          echo ""
          echo "üìê Validating against schemas..."
          
          # Validate book.json files
          for file in books/*/book.json; do
            [ -f "$file" ] || continue
            echo "‚Üí $file (using schema.json)"
            ajv validate -s schema.json -d "$file"
          done
          
          # Validate chapters.json files
          for file in books/*/chapters.json; do
            [ -f "$file" ] || continue
            echo "‚Üí $file (using chapters.schema.json)"
            ajv validate -s chapters.schema.json -d "$file"
          done
          
          # Validate individual hadith files
          for file in books/*/hadiths/*.json; do
            [ -f "$file" ] || continue
            echo "‚Üí $file (using hadith.schema.json)"
            ajv validate -s hadith.schema.json -d "$file"
          done
          
          echo ""
          echo "‚úÖ All JSON files validated successfully!"